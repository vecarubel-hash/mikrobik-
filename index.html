<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>–ú—ñ–∫—Ä–æ–±–∏–∫ 4-–ê: –ë–∏—Ç–≤–∞ –†—ñ–≤–Ω—ñ–≤</title>
    <style>
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #E0F7FA; 
            position: fixed; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            touch-action: none;
        }
        canvas { display: block; }
        
        .ui-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(255, 255, 255, 0.9); z-index: 1000;
        }
        
        .title { font-size: 36px; color: #FF4500; text-shadow: 2px 2px #FFD700; margin-bottom: 20px; text-align: center; }
        
        .btn-start {
            padding: 20px 50px; font-size: 28px; background: #4CAF50;
            color: white; border: none; border-radius: 25px;
            box-shadow: 0 8px #2E7D32; cursor: pointer;
        }

        #joy-bg { 
            position: absolute; bottom: 50px; left: 50px; 
            width: 120px; height: 120px; background: rgba(0,0,0,0.1); 
            border-radius: 50%; border: 3px solid rgba(0,0,0,0.2);
            touch-action: none; z-index: 100; display: none;
        }
        #joy-stick { 
            position: absolute; top: 35px; left: 35px; 
            width: 50px; height: 50px; background: #00E676; 
            border-radius: 50%; border: 3px solid #fff;
        }

        .stats-top {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            background: rgba(255,255,255,0.8);
            padding: 10px; border-radius: 15px; border: 2px solid #FF69B4;
            font-size: 16px; z-index: 50; font-weight: bold;
        }

        /* –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–µ—Ä–µ—Ö–æ–¥—É —Ä—ñ–≤–Ω—è */
        #level-up {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 50px; color: #FFD700; text-shadow: 3px 3px #000;
            display: none; z-index: 2000; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="menu" class="ui-screen">
        <div class="title">ü¶† –ú–Ü–ö–†–û–ë–ò–ö 4-–ê <br> –ï–í–û–õ–Æ–¶–Ü–Ø</div>
        <div id="last-score" style="font-size: 20px; margin-bottom: 10px;"></div>
        <div style="font-size: 16px; margin-bottom: 20px; text-align: center; color: #555;">
            –ó–±–∏—Ä–∞–π –±–∞–ª–∏, —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ –Ω–æ–≤—ñ —Ä—ñ–≤–Ω—ñ! <br>
            –û—Å—Ç–µ—Ä—ñ–≥–∞–π—Å—è –∑–ª–∏—Ö –º—ñ–∫—Ä–æ–±—ñ–≤: üëæ üëΩ üëπ
        </div>
        <button class="btn-start" onclick="startGame()">–ü–û–ß–ê–¢–ò –ì–†–£</button>
    </div>

    <div id="stats" class="stats-top" style="display: none;">
        <div>‚ö° <span id="energy-val">100</span>%</div>
        <div>üèÜ –†—ñ–≤–µ–Ω—å: <span id="level-val">1</span></div>
        <div>‚≠ê –ë–∞–ª–∏: <span id="score-val">0</span></div>
    </div>

    <div id="level-up">–†–Ü–í–ï–ù–¨ –ü–†–û–ô–î–ï–ù–û! üéâ</div>

    <canvas id="game"></canvas>
    <div id="joy-bg"><div id="joy-stick"></div></div>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const joyBg = document.getElementById('joy-bg');
        const joyStick = document.getElementById('joy-stick');
        const menu = document.getElementById('menu');
        const levelUpText = document.getElementById('level-up');

        let width, height, gameState = "menu";
        let level = 1;
        let score = 0;
        let energy = 100;
        
        const foodList = ['üç¨', 'üçî', 'üçé', 'üçï', 'üç∞'];
        const goodList = ['üìö', 'üìñ', 'üåü', 'üíé'];
        const enemyList = ['üëæ', 'üëΩ', 'üëπ', 'üëª', 'üë∫'];

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        const player = { x: 0, y: 0, size: 35, vx: 0, vy: 0 };
        let items = [];

        function startGame() {
            gameState = "playing";
            level = 1;
            score = 0;
            energy = 100;
            menu.style.display = "none";
            document.getElementById('stats').style.display = "flex";
            joyBg.style.display = "block";
            player.x = width / 2;
            player.y = height / 2;
            items = [];
            spawnLevel();
        }

        // –ö–ï–†–£–í–ê–ù–ù–Ø (–∑–∞–ª–∏—à–∏–ª–∏ –ø–æ–≤—ñ–ª—å–Ω–∏–º)
        const maxDist = 45;
        function updateJoystick(e) {
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            const rect = joyBg.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            let dx = touch.clientX - cx;
            let dy = touch.clientY - cy;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist > maxDist) { dx *= maxDist / dist; dy *= maxDist / dist; }
            joyStick.style.transform = `translate(${dx}px, ${dy}px)`;
            player.vx = dx / 12;
            player.vy = dy / 12;
        }

        joyBg.addEventListener('touchstart', updateJoystick);
        joyBg.addEventListener('touchmove', updateJoystick);
        window.addEventListener('touchend', () => {
            joyStick.style.transform = `translate(0px, 0px)`;
            player.vx = 0; player.vy = 0;
        });

        function spawnLevel() {
            items = [];
            // –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–æ—Ä–æ–≥—ñ–≤ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ä—ñ–≤–Ω—è
            let numEnemies = 3 + level * 2; 
            for(let i=0; i<numEnemies; i++) spawnItem('enemy');
            for(let i=0; i<5; i++) spawnItem('food');
            for(let i=0; i<3; i++) spawnItem('good');
        }

        function spawnItem(type) {
            let list = type === 'enemy' ? enemyList : (type === 'food' ? foodList : goodList);
            items.push({
                type: type,
                emoji: list[Math.floor(Math.random() * list.length)],
                x: Math.random() * (width - 60) + 30,
                y: Math.random() * (height - 60) + 30,
                size: 30,
                angle: Math.random() * Math.PI * 2,
                speed: type === 'enemy' ? (0.5 + level * 0.2) : 0
            });
        }

        function checkLevelUp() {
            const goal = level * 500; // –¶—ñ–ª—å —Ä—ñ–≤–Ω—è
            if (score >= goal) {
                level++;
                energy = Math.min(100, energy + 30);
                levelUpText.style.display = "block";
                setTimeout(() => levelUpText.style.display = "none", 2000);
                spawnLevel();
            }
        }

        function update() {
            if (gameState !== "playing") return;

            player.x += player.vx;
            player.y += player.vy;
            
            if (player.x < player.size) player.x = player.size;
            if (player.x > width - player.size) player.x = width - player.size;
            if (player.y < player.size) player.y = player.size;
            if (player.y > height - player.size) player.y = height - player.size;

            energy -= 0.03 + (level * 0.005); 
            
            document.getElementById('energy-val').innerText = Math.max(0, Math.floor(energy));
            document.getElementById('level-val').innerText = level;
            document.getElementById('score-val').innerText = score;

            items.forEach((item, index) => {
                if (item.type === 'enemy') {
                    item.x += Math.cos(item.angle) * item.speed;
                    item.y += Math.sin(item.angle) * item.speed;
                    if (item.x < 10 || item.x > width - 10 || item.y < 10 || item.y > height - 10) item.angle += Math.PI;
                }

                const d = Math.hypot(player.x - item.x, player.y - item.y);
                if (d < player.size + 15) {
                    if (item.type === 'food') { energy = Math.min(100, energy + 15); score += 20; }
                    else if (item.type === 'good') { score += 100; }
                    else if (item.type === 'enemy') { energy -= 20; score = Math.max(0, score - 50); }
                    
                    items.splice(index, 1);
                    spawnItem(item.type); // –û–¥—Ä–∞–∑—É —Å—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–º—ñ–Ω—É
                }
            });

            checkLevelUp();

            if (energy <= 0) {
                gameState = "menu";
                menu.style.display = "flex";
                document.getElementById('last-score').innerText = "–¢–≤—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: " + score + " –±–∞–ª—ñ–≤ (–†—ñ–≤–µ–Ω—å " + level + ")";
                document.getElementById('stats').style.display = "none";
                joyBg.style.display = "none";
            }
        }

        function draw() {
            // –§–æ–Ω –∑–º—ñ–Ω—é—î—Ç—å—Å—è –∑ —Ä—ñ–≤–Ω–µ–º
            ctx.fillStyle = level % 2 === 0 ? "#E8F5E9" : "#E1F5FE";
            ctx.fillRect(0, 0, width, height);

            if (gameState === "playing") {
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.font = "40px 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif";

                items.forEach(item => {
                    ctx.fillText(item.emoji, item.x, item.y);
                });

                // –ú—ñ–∫—Ä–æ–±–∏–∫
                const time = Date.now() * 0.005;
                const pSize = player.size + Math.sin(time) * 2;
                ctx.fillStyle = energy > 30 ? "#4CAF50" : "#F44336";
                ctx.beginPath(); ctx.arc(player.x, player.y, pSize, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = "white"; ctx.lineWidth = 4; ctx.stroke();

                // –û—á—ñ
                ctx.fillStyle = "white";
                ctx.beginPath(); ctx.arc(player.x-12, player.y-8, 9, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(player.x+12, player.y-8, 9, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "black";
                ctx.beginPath(); ctx.arc(player.x-12 + (player.vx*2), player.y-8 + (player.vy*2), 4, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(player.x+12 + (player.vx*2), player.y-8 + (player.vy*2), 4, 0, Math.PI*2); ctx.fill();
            }

            update();
            requestAnimationFrame(draw);
        }
        draw();
    </script>
</body>
</html>
